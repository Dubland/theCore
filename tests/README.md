# theCore on-device and system tests

theCore testing facilities provides way to create on-device and system tests in modular and reusable manner.
theCore uses [the Unity test framework](http://www.throwtheswitch.org/unity/) to create test cases.

## Basic entities

### Test cases

A test case is a code that performs validation of the particular theCore component or module.

Each test, or test case, resides in separate directory under [`cases`](cases) dir.
To be recognizable by theCore testing facilities the test case must contain a definition file with `case_defs.cmake` name.

Test case definition file must (at least) define `CASE_SOURCES` CMake variable.
`CASE_SOURCES` must contain list of test case source files.

See [the unity_demo test case](cases/unity_demo) as an example.

### Targets and MCUs

A target is a board where tests should be executed.

Multiple boards can be built around single MCU type.
MCU types are placed in the [`mcus`](mcus) directory.
Each MCU must contain `mcu_defs.cmake` and `mcu_defs.hpp` files.
Those definition files can contain arbitrary data specific to the concrete microcontroller.

For example, [STM32 F407 MCU definition file](mcus/stm32f407/mcu_defs.cmake) sets platform associated with that MCU (`CONFIG_PLATFORM`) and MCU model (`CONFIG_PLATFORM_DEVICE`).

Targets are residing in [`targets`](targets) directory and can reuse MCU definitions in its own definition files: `target_defs.cmake` and `target_defs.hpp`.
Targets must also declare set of test suites that they can handle (more on this [later](#suites)).

See [STM32 discovery target](targets/stm32f4discovery_simple) as an example.

### Suites

Every target can run _limited_ set of possible tests.
Limitations might be caused by lack of ROM, RAM or absence of the required hardware.
Sets of tests that can be executed on the target called **suite**.

Suites are specific to the target, thus placed under `<target_name>/suites` directory.
Suites are compiled into executables, thus every suite must contain ordinary `CMakeLists.txt` usable with theCore.

Suite does not need to contain any source files except the init code (usually placed in `suite_init.cpp`) that runs when board starts.
Suite launchers are autogenerated by [`gen_suite.py`](../scripts/gen_suite.py) script.

See [Unity demo suite on stm32f4 discovery target](targets/stm32f4discovery_simple/suites/unity_demo) as an example.

## Building theCore suites

Existing test suites can be compiled by following procedure (do not forget to start [`nix-shell`](../README.md#getting-started)):

```
mkdir build
cd build
cmake ..
make
```

Paths to suite binaries are recorded in `suite_list.txt` file in build directory:

```
$ cat suite_list.txt
platform_bat,tivac_tm4,/tmp/theCore/tests/build/tivac_tm4/platform_bat.gnu//build/platform_bat,/tmp/build3/tivac_tm4/platform_bat.gnu//build/platform_bat.bin
platform_bat,stm32f4discovery_simple,/tmp/theCore/tests/build/stm32f4discovery_simple/platform_bat.gnu//build/platform_bat,/tmp/build3/stm32f4discovery_simple/platform_bat.gnu//build/platform_bat.bin
platform_bat,stm32f4discovery_simple,/tmp/theCore/tests/build/stm32f4discovery_simple/platform_bat.clang//build/platform_bat,/tmp/build3/stm32f4discovery_simple/platform_bat.clang//build/platform_bat.bin
unity_demo,stm32f4discovery_simple,/tmp/theCore/tests/build/stm32f4discovery_simple/unity_demo.gnu//build/unity_demo,/tmp/build3/stm32f4discovery_simple/unity_demo.gnu//build/unity_demo.bin
unity_demo,tivac_tm4,/tmp/theCore/tests/build/tivac_tm4/unity_demo.gnu//build/unity_demo,/tmp/build3/tivac_tm4/unity_demo.gnu//build/unity_demo.bin
```

## Launching suites

Suite binaries [obtained in previous section](#building-thecore-suites) can be flashed onto the board using either manual approach (using appropriate programmer) or using [`flasher.py`](../scripts/flasher.py) script.

The flasher script takes `suite_list.txt` and [description of connected devices](../scripts/connected_devices_example.json) and tries to flash suite binaries to connected boards.

## Relationship to the [`examples`](../examples)

Test cases are suites are not so well documented and indicative to be threatened as examples.
Some tests can evolve enough to be separated into an example though.




